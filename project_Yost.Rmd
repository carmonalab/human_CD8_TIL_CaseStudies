---
title: "CD8 TIL reference mapping"
author: "Paul Gueguen, Massimo Anreatta, and Santiago  Carmona"
date: "`r format(Sys.Date(),'%e de %B, %Y')`"
output: 
  rmdformats::downcute:
    lightbox: true
    thumbnails: false
    self_contained: true
    gallery: true
    code_folding: show
  pkgdown:
    as_is: true
---

```{r, include=FALSE, fig.width=16, fig.height=12}
renv::restore()
library(Seurat)
library(tidyverse)
library(scGate)
library(STACAS)
library(data.table)
library(GEOquery)
library(patchwork)
library(ProjecTILs)
library(gridExtra)
library(ggrepel)
library(UCell)
library(plotly)
#options(future.globals.maxSize= 5000*1024^2)
```

## Loading reference

```{r}
path <- "~/Dropbox/CSI/Datasets/projectTils/"
ref.cd8 <- readRDS(sprintf("%s/NickB.Human_CD8_TILs_atlas.rds",path))

cols <- ref.cd8@misc$atlas.palette

# Plotting
DimPlot(ref.cd8,  group.by = 'functional.cluster', label = T, repel = T, cols = cols) + theme(aspect.ratio = 1)
```

## Mapping of [Yost et al. 2019](https://pubmed.ncbi.nlm.nih.gov/31359002/)

The original annotation from this study seemed not ideal. Let's check our initial hypotheses.

```{r}
# Load data
datadir <- "input/Yost/"
cached.object <- paste0(datadir,"Yost.seurat.rds")
if (!file.exists(cached.object)) {
    library(GEOquery)
    geo_acc <- "GSE123813"
    
    gse <- getGEO(geo_acc)
    series <- paste0(geo_acc, "_series_matrix.txt.gz")
    system(paste0("mkdir -p ", datadir))
    getGEOSuppFiles(geo_acc, baseDir = datadir)
    ## Load expression matrix and metadata
    exp.mat <- read.delim(sprintf("%s/%s/GSE123813_bcc_scRNA_counts.txt.gz",
        datadir, geo_acc), header = F, sep = "\t")
    
    query.object <- CreateSeuratObject(counts = exp.mat, project = "Yost", min.cells = 3, min.features = 50)
    
    meta <- read.delim(sprintf("%s/%s/GSE123813_bcc_all_metadata.txt.gz", datadir, geo_acc), header = T, sep = "\t")
    meta.T <- read.delim(sprintf("%s/%s/GSE123813_bcc_tcell_metadata.txt.gz", datadir, geo_acc), header = T, sep = "\t")
    response  <- read.csv(meta_response, header=T, sep=",")
    
    query.object <- AddMetaData(query.object, meta$patient, col.name="patient")
    
    rownames(meta) <- meta$cell.id
    rownames(response) <- response$Patient
    
    meta.T.c <- meta.T$cluster
    names(meta.T.c) <- meta.T$cell.id
    
    query.object <- AddMetaData(query.object, meta)
    query.object <- AddMetaData(query.object, meta.T.c, col.name = "cluster.T")
    
    query.object@meta.data$Response <- response$Response[match(query.object$patient, response$Patient)]
    
    saveRDS(query.object, cached_seurat)

} else {
    query.object <- readRDS(cached.object)
}
```

```{r}
# Normalize data
query.object <- NormalizeData(query.object)
query.object <- ScaleData(query.object)

# Setting up original UMAP space
query.object@reductions[["umap"]] <- CreateDimReducObject(embeddings = cbind(query.object$UMAP1, query.object$UMAP2), key = "UMAP_", assay = DefaultAssay(query.object))
DimPlot(query.object, reduction = 'umap', group.by = 'patient')
DimPlot(query.object, reduction = 'umap', group.by = 'treatment')
DimPlot(query.object, reduction = 'umap', group.by = 'cluster', label = T)

# Filter cells without patient ID to match paper annotation
query.object<- query.object[,which(!is.na(query.object$patient))]
```

Projection into the reference

```{r}
# Mapping
query.list <- SplitObject(query.object, split.by = "patient")
query.projected <- Run.ProjecTILs(query.list, ref.cd8, filter.cells = T, ncores = 4)
```

```{r}
lapply(names(query.projected), function(n) {
  x <- query.projected[[n]]
  plot.projection(ref.cd8, x, linesize = 0.5, pointsize = 0) + ggtitle(n)
})  
```

Merge and split by original annotation

```{r}
merged <- Reduce(ProjecTILs::merge.Seurat.embeddings, query.projected)

table(merged$cluster, merged$functional.cluster)
table(merged$cluster.T, merged$functional.cluster, useNA = "ifany")

```

Compare CD8T subtypes

```{r fig.height=3}
merged <- subset(merged, subset=cluster.T %in% c("CD8_act","CD8_eff","CD8_ex","CD8_ex_act","CD8_mem","Naive"))

query.bysub <- SplitObject(merged, split.by = "cluster.T")
pll <- list()

for (n in names(query.bysub)) {
  x <- query.bysub[[n]]
  pll[[n]] <- plot.projection(ref.cd8, x, linesize = 0.5, pointsize = 0) + ggtitle(n) +
    theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(), aspect.ratio = 1)
}
wrap_plots(pll)

ggsave("plots/Yost_projected_by_subtype.png", height=6, width=12)
```

```{r fig.height=4, fig.width=8}
genes4radar <- c('LEF1', "TCF7", "CCR7", "GZMK", "FGFBP2",'FCGR3A','KLRG1',"PDCD1",
                                  'ZNF683','ITGAE', "CRTAM", "CD200","HAVCR2",
                                  "TOX", "ENTPD1", 'SLC4A10','TRAV1-2')

plot.states.radar(ref.cd8, query = query.bysub, min.cells = 20,
                  genes4radar = genes4radar) 

```

```{r fig.height=4, fig.width=8}
#By subtype
for (n in names(query.bysub)) {
  pll <- plot.states.radar(ref.cd8, query = query.bysub[[n]], min.cells = 20,
                  genes4radar = genes4radar, return.as.list = TRUE)
  
  p <- wrap_plots(pll) + plot_annotation(sprintf("Profiles for %s", n))
  plot(p)
  
  ggsave(sprintf("plots/Yost_radars_by_subtype.%s.pdf", n), height=9, width=14)
}
```

What was defined as Naive by Yost et al. is in fact composed of CM, EM, TRM and MAITs, with good correspondance of expression profiles.

CD8_ex also contain TIM3- Tpex and potentially TRM

CD8_act is a mixture of many different cell types (this subtype was contributed almost exclusively by one patient)

CD8_mem are also a mix of CM, EM and even TEX

CD8_eff are projected into KLRG1+FGFBP2+ TEMRA
